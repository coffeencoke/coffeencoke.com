<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<title>Serving Rails with a Subdirectory Root Path - Coffeencoke</title>
<meta name="author" content="Matt Simpson">


<meta name="description" content="Blog for Coffeencoke - Matt Simpson - about Computer Science, Programming Languages, Community, and Entrepreneurship">

<meta name="keywords" content="Matt, Simpson, Matt Simpson, Coffeencoke, Computer Science, Programming Languages, Community, Entrepreneurship, Entrepreneur, Software Development, St. Louis, Ruby, Rails, Ruby on Rails">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="/favicon.png" rel="icon">

<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
<link href="/stylesheets/print.css" media="print" rel="stylesheet" type="text/css" />
<!--[if IE]>
    <link href="/stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css" />
<![endif]-->

</head>
<body>
  <header id='main-header'>
    <div>
      <h1><a href="/">Coffeencoke</a></h1>
      
        <h2><a href="/">Matt Simpson's blog</a></h2>
      
      <nav>
        <ul>
          <li><a  href='/'>Home</a></li>
          <li><a  href='/portfolio.html'>Portfolio</a></li>
          <li><a  class='current'  href='/blog'>Blog</a></li>
          <li><a href='http://github.com/coffeencoke'>Github</a></li>
          <li><a href='http://twitter.com/coffeencoke'>Twitter</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <div id='main-content'>
    <div id='blog'>
      
<article>
  <header>
    <h1 class="entry-title">
      
      Serving Rails with a Subdirectory Root Path
      
    </h1>
    <ul class="meta">
      
      <li>Developmentdevelopmenthostinginstalllinuxnginxprogrammingrailsrails 3rails3rubyruby 1.9Ruby on Railsserverserversunicorn</li>
      
      <li>








  



<time datetime="2012-12-31T00:00:00-06:00" pubdate data-updated="true">Dec 31<span>st</span>, 2012</time></li>
    </ul>
  </header>

  <div class="entry-content"><p><strong>View the <a href="http://railsgrammer.com/2013/02/sub-directory-rails-app-part-2/">Sub Directory Rails App â€“ Part 2</a></strong> post for an update on this topic. I have recently had the pleasure of serving a rails application where the root url is a subdirectory so that instead of <code>myapp.company.com</code> or <code>myapp.com</code> it is <code>company.com/myapp</code>. The web is full of guides for how to do this, but I <strong>did not</strong> find a guide that was specific to <strong>Nginx, Unicorn, Ruby 1.9.3, and Rails 3</strong>. <strong>You can view all files to configure this by <a href="https://gist.github.com/4422617" title="Coffeencoke Gist" target="_blank">viewing this gist</a>.</strong> First, you must be serving your unicorn workers using a unicorn socket. Point your Nginx configuration to use the unicorn sock</p>

<pre line=1>upstream unicorn_socket_for_myapp {
  server unix:/home/coffeencoke/apps/myapp/current/tmp/sockets/unicorn.sock fail_timeout=0;
}
</pre>

<p>Next, setup your Nginx config to receive requests for the domain your app will be within:</p>

<pre line=1>server {
  listen          80;
  server_name     coffeencoke.com www.coffeencoke.com;
}
</pre>

<p>Then, add a location block for the subdirectory you want your rails app to live. This should go inside of the server block.</p>

<pre># If static file exists, load directly from Nginx, bypass Rails
  # Otherwise, pass request off to unicorn proxy
  location /myapp/ {
    try_files $uri @unicorn_proxy;
  }
 
  location @unicorn_proxy {
    proxy_pass http://unix:/home/coffeencoke/apps/myapp/current/tmp/sockets/unicorn.sock;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
</pre>

<p>Now you need to update your rails application so that it uses that subdirectory when generating urls and mapping to Actions and Controllers. Add a scope to your routes file like so:</p>

<pre>MyApp::Application.routes.draw do
  scope '/myapp' do
    root :to => 'registrations#new'
    
    # other routes are always inside this block
    # ...
  end
end
</pre>

<p>Your rails app will now map to</p>

<p><code>/myapp/registrations/new</code>, instead of <code>/registrations/new</code> The problem however, is that when I am developing I do not want to write dependencies on this path structure, in case the application some day is not in a sub domain, also because it's annoying. Therefor, I created a module and included it into the routes file and used it like so:</p>

<pre>require_relative '../lib/route_scoper'
 
MyApp::Application.routes.draw do
  scope RouteScoper.root do
    root :to => 'registrations#new'
    
    # other routes are always inside this block
    # ...
  end
end
</pre>

<p>the module looks like this:</p>

<pre>require 'rails/application'
 
module RouteScoper
  def self.root
    Rails.application.config.root_directory
  rescue NameError
    '/'
  end
end
</pre>

<p>Pretty simple, if the environment has configured a specific root directory, then use that, otherwise, use '/', which is the same as not specifying anything. Now in my config/environments/production.rb file I have the following:</p>

<pre>MyApp::Application.configure do
  # Contains configurations for the production environment
  # ...
  
  # Serve the application at /myapp
  config.root_directory = '/myapp'
end
</pre>

<p>And in my config/environments/development.rb file, I do not specify</p>

<p><code>config.root_directory</code> so that it uses the normal url root.</p>
</div>
</article>


    </div>
  </div>
  <footer id='main-footer'>
  <div>
    <section id='currentProfessionalInterests'>
      <h1>Current Professional Interests</h1>
      <article>
        <h2>Presenting and Contributing</h2>
        <p>To my local community here in St. Louis, Missouri.</p>
      </article>
      <article>
        <h2>Working On A Project</h2>
        <p>
          <a href='http://twitter.com/asynchrony' title='Asynchrony Twitter'>@asynchrony</a>
          by leading my team developing software.
        </p>
      </article>
      <article>
        <h2>Designing and Developing Software</h2>
        <p>
          For myself, the community, and other people.
        </p>
      </article>
      <article>
        <h2>Doing Side Work </h2>
        <p>
          for small businesses Needing software solutions.
        </p>
      </article>
      <article>
        <h2>Working on Entrepreneurial Ideas</h2>
        <p>
          of my own with my lovely wife, 
          <a href='http://twitter.com/photosbybetty' title="Betty's Twitter">@photosbybetty</a>.
        </p>
      </article>
    </section>
    <section id='upcomingEvents'>
      <h1>Upcoming Events</h1>
      <article>
        <h2>Presenting about Fear in Programming</h2>
        <p>May of 2013 - STL Ruby Meetup</p>
        <p>August of 2013 - Lambda Lounge</p>
        <p>September of 2013 - Python Group</p>
      </article>
      <article>
        <h2>Contact me</h2>
        <p>
          If you would like to talk about any of my professional interests.
        </p>
        <p>
          By 
          <a href='mailto:matt@railsgrammer.com'>Email</a>
          or on
          <a href='https://twitter.com/coffeencoke'>Twitter</a>
        </p>
      </article>
    </section>
    <section id='copyright'>
      <p>
        content of posts and pages on this site are Copyright &copy; 2013 Matt Simpson. 
      </p>
      <p>
        this site proudly uses <a href="https://github.com/mojombo/jekyll">jekyll</a>, 
        you can <a href="https://github.com/coffeencoke/coffeencoke.com">view the source on github</a>
      </p>
    </section>
  </div>
</footer>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-9324092-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>



</body>

